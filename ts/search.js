(()=>{var g={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","\u2026":"&hellip;"};function f(h){return g[h]||h}function d(h){return h.replace(/[&<>"]/g,f)}function T(h){return h.replace(/[.*+\-?^${}()|[\]\\]/g,"\\$&")}var m=class h{data;form;input;list;resultTitle;resultTitleTemplate;constructor({form:e,input:r,list:t,resultTitle:a,resultTitleTemplate:n}){this.form=e,this.input=r,this.list=t,this.resultTitle=a,this.resultTitleTemplate=n,this.handleQueryString(),this.bindQueryStringChange(),this.bindSearchForm()}static processMatches(e,r,t=!0,a=140,n=20){r.sort((c,o)=>c.start-o.start);let l=0,i=0,s=0,u=[];for(;l<r.length;){let c=r[l];t&&c.start-n>i?(u.push(`${d(e.substring(i,i+n))} [...] `),u.push(`${d(e.substring(c.start-n,c.start))}`),s+=n*2):(u.push(d(e.substring(i,c.start))),s+=c.start-i);let o=l+1,p=c.end;for(;o<r.length&&r[o].start<=p;)p=Math.max(r[o].end,p),++o;if(u.push(`<mark>${d(e.substring(c.start,p))}</mark>`),s+=p-c.start,l=o,i=p,t&&s>a)break}if(i<e.length){let c=e.length;t&&(c=Math.min(c,i+n)),u.push(`${d(e.substring(i,c))}`),t&&c!=e.length&&u.push(" [...]")}return u.join("")}async searchKeywords(e){let r=await this.getData(),t=[],a=new RegExp(e.filter((n,l,i)=>(i[l]=T(n),n.trim()!=="")).join("|"),"gi");for(let n of r){let l=[],i=[],s={...n,preview:"",matchCount:0},u=n.content.matchAll(a);for(let o of Array.from(u))i.push({start:o.index,end:o.index+o[0].length});let c=n.title.matchAll(a);for(let o of Array.from(c))l.push({start:o.index,end:o.index+o[0].length});l.length>0&&(s.title=h.processMatches(s.title,l,!1)),i.length>0?s.preview=h.processMatches(s.content,i):s.preview=d(s.content.substring(0,140)),s.matchCount=l.length+i.length,s.matchCount>0&&t.push(s)}return t.sort((n,l)=>l.matchCount-n.matchCount)}async doSearch(e){let r=performance.now(),t=await this.searchKeywords(e);this.clear();for(let n of t)h.createArticleElement(n);let a=performance.now();this.resultTitle.innerText=this.generateResultTitle(t.length,((a-r)/1e3).toPrecision(1)),pjax.refresh(document)}generateResultTitle(e,r){return this.resultTitleTemplate.replace("#PAGES_COUNT",e).replace("#TIME_SECONDS",r)}async getData(){if(!this.data){let e=this.form.dataset.json;this.data=await fetch(e).then(t=>t.json());let r=new DOMParser;for(let t of this.data)t.content=r.parseFromString(t.content,"text/html").body.innerText}return this.data}bindSearchForm(){let e="",r=t=>{t.preventDefault();let a=this.input.value.trim();if(h.updateQueryString(a,!0),a==="")return e="",this.clear();e!==a&&(e=a,this.doSearch(a.split(" ")))};this.input.addEventListener("input",r),this.input.addEventListener("compositionend",r)}clear(){this.list.innerHTML="",this.resultTitle.innerText=""}bindQueryStringChange(){window.addEventListener("popstate",e=>{this.handleQueryString()})}handleQueryString(){let r=new URL(window.location.toString()).searchParams.get("keyword");this.input.value=r,r?this.doSearch(r.split(" ")):this.clear()}static updateQueryString(e,r=!1){let t=new URL(window.location.toString());e===""?t.searchParams.delete("keyword"):t.searchParams.set("keyword",e),r?window.history.replaceState("","",t.toString()):window.history.pushState("","",t.toString())}static render(e){return createElement("article",null,createElement("a",{href:e.permalink},createElement("div",{class:"article-details"},createElement("h2",{class:"article-title",dangerouslySetInnerHTML:{__html:e.title}}),createElement("section",{class:"article-preview",dangerouslySetInnerHTML:{__html:e.preview}})),e.image&&createElement("div",{class:"article-image"},createElement("img",{src:e.image,loading:"lazy"}))))}static createArticleElement(e){let r=document.createElement("article"),t=document.createElement("a");t.href=e.permalink;let a=document.createElement("div");a.className="article-details";let n=document.createElement("h2");n.className="article-title",n.innerHTML=e.title;let l=document.createElement("section");if(l.className="article-preview",l.innerHTML=e.preview,a.appendChild(n),a.appendChild(l),t.appendChild(a),e.image){let i=document.createElement("div");i.className="article-image";let s=document.createElement("img");s.src=e.image,s.loading="lazy",i.appendChild(s),t.appendChild(i)}r.appendChild(t),document.querySelector(".search-result--list").appendChild(r)}};function w(){if(document.querySelector(".search-result")){let e=document.querySelector(".search-form"),r=e.querySelector("input"),t=document.querySelector(".search-result--list"),a=document.querySelector(".search-result--title");new m({form:e,input:r,list:t,resultTitle:a,resultTitleTemplate:window.searchResultTitleTemplate})}}var v=m;})();
